#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-commit quality gates..."

# Run lint-staged for file-specific checks
echo "ğŸ“ Running lint-staged..."
npx lint-staged

# Check if there are any staged files
if git diff --cached --quiet; then
  echo "â„¹ï¸  No staged files to check"
  exit 0
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)
echo "ğŸ“ Staged files: $(echo "$STAGED_FILES" | wc -l) files"

# Check for large files
echo "ğŸ“ Checking for large files..."
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    size=$(wc -c < "$file")
    if [ $size -gt 1048576 ]; then # 1MB
      echo "âŒ Large file detected: $file ($(($size / 1024))KB)"
      echo "ğŸ’¡ Consider using Git LFS for large files"
      exit 1
    fi
  fi
done

# Check for sensitive data patterns
echo "ğŸ”’ Checking for sensitive data..."
SENSITIVE_PATTERNS=(
  "password\s*=\s*['\"][^'\"]*['\"]"
  "api[_-]?key\s*=\s*['\"][^'\"]*['\"]"
  "secret\s*=\s*['\"][^'\"]*['\"]"
  "token\s*=\s*['\"][^'\"]*['\"]"
  "private[_-]?key"
  "-----BEGIN\s+(RSA\s+)?PRIVATE\s+KEY-----"
  "sk_live_"
  "pk_live_"
  "AKIA[0-9A-Z]{16}"
)

for file in $STAGED_FILES; do
  if [ -f "$file" ] && [[ "$file" =~ \.(js|ts|jsx|tsx|json|env|yaml|yml)$ ]]; then
    for pattern in "${SENSITIVE_PATTERNS[@]}"; do
      if grep -qiE "$pattern" "$file"; then
        echo "âŒ Potential sensitive data found in $file"
        echo "ğŸ’¡ Please review and remove sensitive information"
        exit 1
      fi
    done
  fi
done

# Check for TODO/FIXME comments in production code
echo "ğŸ“ Checking for TODO/FIXME comments..."
TODO_COUNT=0
for file in $STAGED_FILES; do
  if [ -f "$file" ] && [[ "$file" =~ \.(js|ts|jsx|tsx)$ ]] && [[ ! "$file" =~ __tests__|\.test\.|\.spec\. ]]; then
    todos=$(grep -n -i "TODO\|FIXME\|XXX\|HACK" "$file" || true)
    if [ -n "$todos" ]; then
      echo "âš ï¸  TODO/FIXME found in $file:"
      echo "$todos"
      TODO_COUNT=$((TODO_COUNT + 1))
    fi
  fi
done

if [ $TODO_COUNT -gt 5 ]; then
  echo "âŒ Too many TODO/FIXME comments ($TODO_COUNT). Please address some before committing."
  exit 1
fi

# Check for console.log statements in production code
echo "ğŸ–¥ï¸  Checking for console statements..."
CONSOLE_COUNT=0
for file in $STAGED_FILES; do
  if [ -f "$file" ] && [[ "$file" =~ \.(js|ts|jsx|tsx)$ ]] && [[ ! "$file" =~ __tests__|\.test\.|\.spec\.|\.stories\. ]]; then
    consoles=$(grep -n "console\." "$file" || true)
    if [ -n "$consoles" ]; then
      echo "âš ï¸  Console statements found in $file:"
      echo "$consoles"
      CONSOLE_COUNT=$((CONSOLE_COUNT + 1))
    fi
  fi
done

if [ $CONSOLE_COUNT -gt 0 ]; then
  echo "âš ï¸  Found console statements in $CONSOLE_COUNT files. Consider removing them or using a proper logger."
fi

# Check for debugger statements
echo "ğŸ› Checking for debugger statements..."
for file in $STAGED_FILES; do
  if [ -f "$file" ] && [[ "$file" =~ \.(js|ts|jsx|tsx)$ ]]; then
    if grep -q "debugger" "$file"; then
      echo "âŒ Debugger statement found in $file"
      echo "ğŸ’¡ Please remove debugger statements before committing"
      exit 1
    fi
  fi
done

# Check for merge conflict markers
echo "ğŸ”€ Checking for merge conflict markers..."
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    if grep -q "^<<<<<<< \|^======= \|^>>>>>>> " "$file"; then
      echo "âŒ Merge conflict markers found in $file"
      echo "ğŸ’¡ Please resolve merge conflicts before committing"
      exit 1
    fi
  fi
done

# Check for package-lock.json and yarn.lock consistency
echo "ğŸ“¦ Checking package manager consistency..."
if echo "$STAGED_FILES" | grep -q "package\.json"; then
  if [ -f "package-lock.json" ] && [ -f "yarn.lock" ]; then
    echo "âŒ Both package-lock.json and yarn.lock found"
    echo "ğŸ’¡ Please use only one package manager"
    exit 1
  fi
  
  if [ -f "package-lock.json" ] && ! echo "$STAGED_FILES" | grep -q "package-lock\.json"; then
    echo "âŒ package.json modified but package-lock.json not staged"
    echo "ğŸ’¡ Please stage package-lock.json as well"
    exit 1
  fi
fi

# Check TypeScript files for type errors (quick check)
echo "ğŸ” Quick TypeScript check..."
TS_FILES=$(echo "$STAGED_FILES" | grep -E "\.(ts|tsx)$" || true)
if [ -n "$TS_FILES" ]; then
  echo "Checking TypeScript files..."
  if ! npx tsc --noEmit --skipLibCheck; then
    echo "âŒ TypeScript errors found"
    echo "ğŸ’¡ Please fix TypeScript errors before committing"
    exit 1
  fi
fi

# Check for proper test files
echo "ğŸ§ª Checking test coverage for new files..."
NEW_FILES=$(git diff --cached --name-only --diff-filter=A)
for file in $NEW_FILES; do
  if [[ "$file" =~ \.(js|ts|jsx|tsx)$ ]] && [[ ! "$file" =~ __tests__|\.test\.|\.spec\.|\.stories\.|\.config\.|\.d\.ts$ ]]; then
    # Check if corresponding test file exists
    base_name=$(basename "$file" | sed 's/\.[^.]*$//')
    dir_name=$(dirname "$file")
    
    test_patterns=(
      "$dir_name/__tests__/$base_name.test.*"
      "$dir_name/$base_name.test.*"
      "$dir_name/$base_name.spec.*"
    )
    
    has_test=false
    for pattern in "${test_patterns[@]}"; do
      if ls $pattern 2>/dev/null | grep -q .; then
        has_test=true
        break
      fi
    done
    
    if [ "$has_test" = false ]; then
      echo "âš ï¸  New file $file has no corresponding test file"
      echo "ğŸ’¡ Consider adding tests for new functionality"
    fi
  fi
done

# Check commit message format (if available)
if [ -f ".git/COMMIT_EDITMSG" ]; then
  echo "ğŸ“ Checking commit message format..."
  commit_msg=$(head -n 1 ".git/COMMIT_EDITMSG")
  
  # Check for conventional commit format
  if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\(.+\))?: .+"; then
    echo "âš ï¸  Commit message doesn't follow conventional commit format"
    echo "ğŸ’¡ Use format: type(scope): description"
    echo "   Examples: feat(auth): add login functionality"
    echo "            fix(ui): resolve button alignment issue"
  fi
  
  # Check commit message length
  if [ ${#commit_msg} -gt 72 ]; then
    echo "âš ï¸  Commit message is too long (${#commit_msg} chars, max 72)"
    echo "ğŸ’¡ Keep the first line under 72 characters"
  fi
fi

echo "âœ… Pre-commit checks completed successfully!"
echo "ğŸ‰ Ready to commit!"
